name: Comprehensive CI

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: 'true'
        type: boolean
      run_stress:
        description: 'Run stress tests'
        required: false
        default: 'false'
        type: boolean

env:
  CMAKE_BUILD_TYPE: Release
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Code Quality Checks
  # ============================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linters
        run: |
          pip install cpplint cppcheck clang-format flake8 black isort mypy

      - name: Run cpplint
        run: |
          find DeepTreeEcho -name "*.cpp" -o -name "*.h" | head -50 | xargs cpplint --filter=-whitespace,-legal,-build/include_subdir 2>&1 || true

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance --suppress=missingInclude --error-exitcode=0 \
            DeepTreeEcho/ ReservoirEcho/reservoircpp_cpp/ 2>&1 || true

      - name: Check Python formatting
        run: |
          if [ -d "MetaHuman-DNA-Calibration/dna_viewer" ]; then
            black --check --diff MetaHuman-DNA-Calibration/dna_viewer/ || true
            isort --check-only --diff MetaHuman-DNA-Calibration/dna_viewer/ || true
          fi

  # ============================================================================
  # Unit Tests - DeepTreeEcho
  # ============================================================================
  unit-tests-deeptreeecho:
    name: Unit Tests - DeepTreeEcho
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Release, Debug]
        exclude:
          - os: macos-latest
            build_type: Debug
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '2024.01.12'

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtest-dev libeigen3-dev libboost-all-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install googletest eigen boost

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: |
            build
            ~/.cache/vcpkg
          key: ${{ runner.os }}-build-${{ matrix.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.build_type }}-
            ${{ runner.os }}-build-

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTING=ON \
            -DENABLE_COVERAGE=${{ matrix.build_type == 'Debug' && runner.os == 'Linux' }}

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }} -j $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)

      - name: Run Unit Tests
        run: |
          cd build
          ctest --output-on-failure --parallel 2 -L unit -C ${{ matrix.build_type }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-deeptreeecho-${{ matrix.os }}-${{ matrix.build_type }}
          path: build/Testing/

  # ============================================================================
  # Unit Tests - ReservoirCpp
  # ============================================================================
  unit-tests-reservoircpp:
    name: Unit Tests - ReservoirCpp
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtest-dev libeigen3-dev

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: ReservoirEcho/reservoircpp_cpp/build
          key: ${{ runner.os }}-reservoircpp-${{ matrix.build_type }}-${{ hashFiles('ReservoirEcho/reservoircpp_cpp/CMakeLists.txt') }}

      - name: Configure CMake
        working-directory: ReservoirEcho/reservoircpp_cpp
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTING=ON

      - name: Build
        working-directory: ReservoirEcho/reservoircpp_cpp
        run: cmake --build build --config ${{ matrix.build_type }} -j 2

      - name: Run Tests
        working-directory: ReservoirEcho/reservoircpp_cpp/build
        run: ctest --output-on-failure --parallel 2 -C ${{ matrix.build_type }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results-reservoircpp-${{ matrix.os }}
          path: ReservoirEcho/reservoircpp_cpp/build/Testing/

  # ============================================================================
  # Unit Tests - Python (MetaHuman DNA)
  # ============================================================================
  unit-tests-python:
    name: Unit Tests - Python
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov pytest-xdist numpy scipy
          if [ -f MetaHuman-DNA-Calibration/requirements.txt ]; then
            pip install -r MetaHuman-DNA-Calibration/requirements.txt || true
          fi

      - name: Run Python tests
        run: |
          if [ -d "MetaHuman-DNA-Calibration/tests" ]; then
            pytest MetaHuman-DNA-Calibration/tests/ -v --tb=short -n auto || true
          fi
          if [ -d "ReservoirEcho/reservoircpp_py/tests" ]; then
            pytest ReservoirEcho/reservoircpp_py/tests/ -v --tb=short -n auto || true
          fi

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage
          path: .coverage

  # ============================================================================
  # E2E Tests
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests-deeptreeecho, unit-tests-reservoircpp]
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_e2e == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtest-dev libeigen3-dev libboost-all-dev

      - name: Cache build
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-e2e-${{ hashFiles('**/CMakeLists.txt') }}

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON \
            -DBUILD_E2E_TESTS=ON

      - name: Build E2E Tests
        run: cmake --build build --config Release -j $(nproc)

      - name: Run E2E Tests
        run: |
          cd build
          ctest --output-on-failure --parallel 1 -L e2e -C Release --timeout 600

      - name: Upload E2E results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: build/Testing/

  # ============================================================================
  # Stress Tests (Optional)
  # ============================================================================
  stress-tests:
    name: Stress Tests
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_stress == 'true'
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtest-dev libeigen3-dev libboost-all-dev

      - name: Configure and Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON
          cmake --build build --config Release -j $(nproc)

      - name: Run Stress Tests
        run: |
          cd build
          ctest --output-on-failure -R "Stress" -C Release --timeout 1800

  # ============================================================================
  # Performance Benchmarks
  # ============================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [unit-tests-deeptreeecho]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtest-dev libeigen3-dev libboost-all-dev libbenchmark-dev

      - name: Configure and Build
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_BENCHMARKS=ON
          cmake --build build --config Release -j $(nproc)

      - name: Run Benchmarks
        run: |
          cd build
          ctest --output-on-failure -R "Performance|Benchmark" -C Release

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: build/benchmark_results/

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests-deeptreeecho, unit-tests-python]
    
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov libgtest-dev libeigen3-dev
          pip install gcovr pytest pytest-cov

      - name: Configure with coverage
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTING=ON \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

      - name: Build and test
        run: |
          cmake --build build --config Debug -j $(nproc)
          cd build && ctest --output-on-failure -C Debug || true

      - name: Generate coverage report
        run: |
          lcov --capture --directory build --output-file coverage.info --ignore-errors mismatch || true
          lcov --remove coverage.info '/usr/*' '*/test/*' '*/Testing/*' --output-file coverage.info || true
          genhtml coverage.info --output-directory coverage-report || true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report/

  # ============================================================================
  # Documentation Build
  # ============================================================================
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Generate documentation
        run: |
          if [ -f Doxyfile ]; then
            doxygen Doxyfile
          else
            echo "No Doxyfile found, skipping documentation generation"
          fi

      - name: Upload documentation
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/html/

  # ============================================================================
  # Summary
  # ============================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests-deeptreeecho, unit-tests-reservoircpp, unit-tests-python, e2e-tests]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (DeepTreeEcho) | ${{ needs.unit-tests-deeptreeecho.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (ReservoirCpp) | ${{ needs.unit-tests-reservoircpp.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Python) | ${{ needs.unit-tests-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
