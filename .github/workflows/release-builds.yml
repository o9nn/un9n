name: Release Builds

on:
  push:
    tags:
      - 'v*.*.*'
      - 'release-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

env:
  CMAKE_BUILD_TYPE: Release

permissions:
  contents: write
  packages: write

jobs:
  # ============================================================================
  # Version Extraction
  # ============================================================================
  version:
    name: Extract Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            if [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]] || [[ "$VERSION" == *"-rc"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Pre-release: $IS_PRERELEASE"

  # ============================================================================
  # Build - Linux
  # ============================================================================
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: version
    strategy:
      matrix:
        arch: [x64]
        include:
          - arch: x64
            cmake_arch: x86_64
    
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libeigen3-dev \
            libboost-all-dev \
            libgtest-dev \
            ninja-build \
            patchelf

      - name: Cache vcpkg
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/vcpkg
            vcpkg_installed
          key: linux-${{ matrix.arch }}-vcpkg-${{ hashFiles('vcpkg.json') }}

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=install \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTING=OFF \
            -DVERSION_STRING="${{ needs.version.outputs.version }}"

      - name: Build
        run: cmake --build build --config Release -j $(nproc)

      - name: Install
        run: cmake --install build --prefix install

      - name: Package DeepTreeEcho
        run: |
          mkdir -p packages
          tar -czvf packages/deeptreeecho-${{ needs.version.outputs.version }}-linux-${{ matrix.arch }}.tar.gz \
            -C install .

      - name: Build ReservoirCpp
        working-directory: ReservoirEcho/reservoircpp_cpp
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../install-reservoir \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build --config Release -j $(nproc)
          cmake --install build --prefix ../../install-reservoir

      - name: Package ReservoirCpp
        run: |
          tar -czvf packages/reservoircpp-${{ needs.version.outputs.version }}-linux-${{ matrix.arch }}.tar.gz \
            -C install-reservoir .

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: linux-${{ matrix.arch }}-packages
          path: packages/

  # ============================================================================
  # Build - Windows
  # ============================================================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: version
    strategy:
      matrix:
        arch: [x64]
        include:
          - arch: x64
            cmake_arch: x64
            vcpkg_triplet: x64-windows
    
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '2024.01.12'

      - name: Cache vcpkg
        uses: actions/cache@v5
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/installed
            ${{ env.VCPKG_ROOT }}/packages
          key: windows-${{ matrix.arch }}-vcpkg-${{ hashFiles('vcpkg.json') }}

      - name: Install dependencies
        run: |
          vcpkg install eigen3:${{ matrix.vcpkg_triplet }} boost:${{ matrix.vcpkg_triplet }} gtest:${{ matrix.vcpkg_triplet }}

      - name: Configure CMake
        run: |
          cmake -B build -A ${{ matrix.cmake_arch }} `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX=install `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }} `
            -DBUILD_SHARED_LIBS=ON `
            -DBUILD_TESTING=OFF `
            -DVERSION_STRING="${{ needs.version.outputs.version }}"

      - name: Build
        run: cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Install
        run: cmake --install build --prefix install --config Release

      - name: Package DeepTreeEcho
        run: |
          New-Item -ItemType Directory -Force -Path packages
          Compress-Archive -Path install\* -DestinationPath packages\deeptreeecho-${{ needs.version.outputs.version }}-windows-${{ matrix.arch }}.zip

      - name: Build ReservoirCpp
        working-directory: ReservoirEcho/reservoircpp_cpp
        run: |
          cmake -B build -A ${{ matrix.cmake_arch }} `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX=..\..\install-reservoir `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=${{ matrix.vcpkg_triplet }} `
            -DBUILD_SHARED_LIBS=ON
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS
          cmake --install build --prefix ..\..\install-reservoir --config Release

      - name: Package ReservoirCpp
        run: |
          Compress-Archive -Path install-reservoir\* -DestinationPath packages\reservoircpp-${{ needs.version.outputs.version }}-windows-${{ matrix.arch }}.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: windows-${{ matrix.arch }}-packages
          path: packages/

  # ============================================================================
  # Build - macOS
  # ============================================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: version
    strategy:
      matrix:
        arch: [x64, arm64]
        include:
          - arch: x64
            cmake_arch: x86_64
            osx_arch: x86_64
          - arch: arm64
            cmake_arch: arm64
            osx_arch: arm64
    
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Install dependencies
        run: |
          brew install eigen boost googletest ninja

      - name: Configure CMake
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=install \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.osx_arch }} \
            -DBUILD_SHARED_LIBS=ON \
            -DBUILD_TESTING=OFF \
            -DVERSION_STRING="${{ needs.version.outputs.version }}"

      - name: Build
        run: cmake --build build --config Release -j $(sysctl -n hw.ncpu)

      - name: Install
        run: cmake --install build --prefix install

      - name: Package DeepTreeEcho
        run: |
          mkdir -p packages
          tar -czvf packages/deeptreeecho-${{ needs.version.outputs.version }}-macos-${{ matrix.arch }}.tar.gz \
            -C install .

      - name: Build ReservoirCpp
        working-directory: ReservoirEcho/reservoircpp_cpp
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../../install-reservoir \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.osx_arch }} \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build --config Release -j $(sysctl -n hw.ncpu)
          cmake --install build --prefix ../../install-reservoir

      - name: Package ReservoirCpp
        run: |
          tar -czvf packages/reservoircpp-${{ needs.version.outputs.version }}-macos-${{ matrix.arch }}.tar.gz \
            -C install-reservoir .

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: macos-${{ matrix.arch }}-packages
          path: packages/

  # ============================================================================
  # Build - Python Wheels
  # ============================================================================
  build-python:
    name: Build Python Wheels
    runs-on: ${{ matrix.os }}
    needs: version
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install build tools
        run: |
          pip install --upgrade pip setuptools wheel build twine

      - name: Build MetaHuman DNA wheel
        if: hashFiles('MetaHuman-DNA-Calibration/setup.py') != '' || hashFiles('MetaHuman-DNA-Calibration/pyproject.toml') != ''
        working-directory: MetaHuman-DNA-Calibration
        run: |
          pip install -e . || true
          python -m build --wheel || true

      - name: Build ReservoirCpp Python wheel
        if: hashFiles('ReservoirEcho/reservoircpp_py/setup.py') != '' || hashFiles('ReservoirEcho/reservoircpp_py/pyproject.toml') != ''
        working-directory: ReservoirEcho/reservoircpp_py
        run: |
          pip install -e . || true
          python -m build --wheel || true

      - name: Collect wheels
        run: |
          mkdir -p packages
          find . -name "*.whl" -exec cp {} packages/ \; 2>/dev/null || true
        shell: bash

      - name: Upload Python wheels
        uses: actions/upload-artifact@v6
        with:
          name: python-${{ matrix.os }}-${{ matrix.python-version }}-wheels
          path: packages/
          if-no-files-found: ignore

  # ============================================================================
  # Build - Unreal Engine Plugin
  # ============================================================================
  build-unreal-plugin:
    name: Build Unreal Plugin
    runs-on: ${{ matrix.os }}
    needs: version
    strategy:
      matrix:
        os: [windows-latest]
        ue_version: ['5.3', '5.4']
    
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Package UnrealEcho Plugin
        run: |
          New-Item -ItemType Directory -Force -Path packages
          if (Test-Path "UnrealEcho") {
            Compress-Archive -Path UnrealEcho\* -DestinationPath packages\unrealecho-plugin-${{ needs.version.outputs.version }}-ue${{ matrix.ue_version }}.zip
          }
          if (Test-Path "Plugins/CubismUE") {
            Compress-Archive -Path Plugins\CubismUE\* -DestinationPath packages\cubism-plugin-${{ needs.version.outputs.version }}-ue${{ matrix.ue_version }}.zip
          }

      - name: Upload Unreal plugins
        uses: actions/upload-artifact@v6
        with:
          name: unreal-plugins-ue${{ matrix.ue_version }}
          path: packages/
          if-no-files-found: ignore

  # ============================================================================
  # Create Release
  # ============================================================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version, build-linux, build-windows, build-macos, build-python, build-unreal-plugin]
    
    steps:
      - uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: release-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find release-artifacts -name "*.tar.gz" -exec cp {} release/ \;
          find release-artifacts -name "*.zip" -exec cp {} release/ \;
          find release-artifacts -name "*.whl" -exec cp {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Generate release notes
        run: |
          cat > release/RELEASE_NOTES.md << 'EOF'
          # Release ${{ needs.version.outputs.version }}
          
          ## DeepTreeEcho Cognitive Framework
          
          ### Packages
          
          | Platform | Architecture | Package |
          |----------|--------------|---------|
          | Linux | x64 | `deeptreeecho-${{ needs.version.outputs.version }}-linux-x64.tar.gz` |
          | Windows | x64 | `deeptreeecho-${{ needs.version.outputs.version }}-windows-x64.zip` |
          | macOS | x64 | `deeptreeecho-${{ needs.version.outputs.version }}-macos-x64.tar.gz` |
          | macOS | arm64 | `deeptreeecho-${{ needs.version.outputs.version }}-macos-arm64.tar.gz` |
          
          ### ReservoirCpp Library
          
          | Platform | Architecture | Package |
          |----------|--------------|---------|
          | Linux | x64 | `reservoircpp-${{ needs.version.outputs.version }}-linux-x64.tar.gz` |
          | Windows | x64 | `reservoircpp-${{ needs.version.outputs.version }}-windows-x64.zip` |
          | macOS | x64 | `reservoircpp-${{ needs.version.outputs.version }}-macos-x64.tar.gz` |
          | macOS | arm64 | `reservoircpp-${{ needs.version.outputs.version }}-macos-arm64.tar.gz` |
          
          ### Unreal Engine Plugins
          
          - UnrealEcho Plugin (UE 5.3, 5.4)
          - CubismUE Plugin (UE 5.3, 5.4)
          
          ### Python Wheels
          
          Python wheels are available for Python 3.9, 3.10, 3.11, and 3.12 on Linux, Windows, and macOS.
          
          ## Installation
          
          ### C++ Libraries
          
          ```bash
          # Linux/macOS
          tar -xzvf deeptreeecho-${{ needs.version.outputs.version }}-linux-x64.tar.gz -C /usr/local
          
          # Windows
          # Extract to your preferred location and add to PATH
          ```
          
          ### Python
          
          ```bash
          pip install <wheel-file>.whl
          ```
          
          ## Verification
          
          Verify downloads using SHA256SUMS.txt:
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.version }}
          name: Release ${{ needs.version.outputs.version }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: ${{ needs.version.outputs.is_prerelease == 'true' }}
          files: |
            release/*.tar.gz
            release/*.zip
            release/*.whl
            release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Publish to Package Registries
  # ============================================================================
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [version, build-python]
    if: startsWith(github.ref, 'refs/tags/v')
    environment: pypi
    
    steps:
      - name: Download Python wheels
        uses: actions/download-artifact@v7
        with:
          pattern: python-*-wheels
          path: wheels
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: wheels/
          skip-existing: true
        continue-on-error: true

  # ============================================================================
  # Notify
  # ============================================================================
  notify:
    name: Release Notification
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    
    steps:
      - name: Release Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ needs.version.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Built" >> $GITHUB_STEP_SUMMARY
          echo "- Linux x64 packages" >> $GITHUB_STEP_SUMMARY
          echo "- Windows x64 packages" >> $GITHUB_STEP_SUMMARY
          echo "- macOS x64/arm64 packages" >> $GITHUB_STEP_SUMMARY
          echo "- Python wheels (3.9-3.12)" >> $GITHUB_STEP_SUMMARY
          echo "- Unreal Engine plugins" >> $GITHUB_STEP_SUMMARY
