# ReservoirEcho CI - Echo State Network Library
# Comprehensive build, test, and analysis pipeline for ReservoirCpp

name: ReservoirEcho CI

on:
  push:
    branches: [main, develop, 'feature/**', 'claude/**']
    paths:
      - 'ReservoirEcho/**'
      - '.github/workflows/ci-reservoir-echo.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ReservoirEcho/**'
      - '.github/workflows/ci-reservoir-echo.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (Debug/Release/RelWithDebInfo)'
        required: false
        default: 'Release'
      run_sanitizers:
        description: 'Run sanitizer builds'
        required: false
        default: 'true'
        type: boolean

env:
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'Release' }}
  RESERVOIR_DIR: ReservoirEcho/reservoircpp_cpp

jobs:
  # ============================================================================
  # Linux Builds - Primary Platform
  # ============================================================================
  linux-build:
    name: Linux ${{ matrix.compiler }} ${{ matrix.build_type }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        include:
          - compiler: gcc
            cc: gcc-12
            cxx: g++-12
          - compiler: clang
            cc: clang-15
            cxx: clang++-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            libgtest-dev \
            libeigen3-dev \
            ${{ matrix.compiler == 'gcc' && 'g++-12' || 'clang-15' }}

      - name: Configure CMake
        working-directory: ${{ env.RESERVOIR_DIR }}
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTS=ON \
            -DBUILD_EXAMPLES=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        working-directory: ${{ env.RESERVOIR_DIR }}/build
        run: ctest --output-on-failure --parallel $(nproc)

      - name: Upload build artifacts
        if: matrix.build_type == 'Release' && matrix.compiler == 'gcc'
        uses: actions/upload-artifact@v6
        with:
          name: reservoir-echo-linux-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: |
            ${{ env.RESERVOIR_DIR }}/build/lib*
            ${{ env.RESERVOIR_DIR }}/build/*.a
            ${{ env.RESERVOIR_DIR }}/build/*.so
          retention-days: 30

      - name: Upload compile commands
        if: matrix.build_type == 'Debug' && matrix.compiler == 'clang'
        uses: actions/upload-artifact@v6
        with:
          name: compile-commands
          path: ${{ env.RESERVOIR_DIR }}/build/compile_commands.json
          retention-days: 7

  # ============================================================================
  # Sanitizer Builds - Memory and Thread Safety
  # ============================================================================
  linux-sanitizers:
    name: Linux Sanitizer (${{ matrix.sanitizer }})
    runs-on: ubuntu-latest
    if: github.event.inputs.run_sanitizers != 'false'
    strategy:
      fail-fast: false
      matrix:
        sanitizer: [address, thread, undefined]
        include:
          - sanitizer: address
            flags: '-fsanitize=address -fno-omit-frame-pointer'
            env_var: 'ASAN_OPTIONS=detect_leaks=1:abort_on_error=1'
          - sanitizer: thread
            flags: '-fsanitize=thread'
            env_var: 'TSAN_OPTIONS=abort_on_error=1'
          - sanitizer: undefined
            flags: '-fsanitize=undefined -fno-sanitize-recover=all'
            env_var: 'UBSAN_OPTIONS=print_stacktrace=1:abort_on_error=1'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgtest-dev libeigen3-dev clang-15

      - name: Configure CMake with sanitizer
        working-directory: ${{ env.RESERVOIR_DIR }}
        env:
          CC: clang-15
          CXX: clang++-15
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="${{ matrix.flags }}" \
            -DCMAKE_C_FLAGS="${{ matrix.flags }}" \
            -DBUILD_TESTS=ON

      - name: Build
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: cmake --build build --parallel $(nproc)

      - name: Run tests with sanitizer
        working-directory: ${{ env.RESERVOIR_DIR }}/build
        env:
          ${{ matrix.sanitizer == 'address' && 'ASAN_OPTIONS' || (matrix.sanitizer == 'thread' && 'TSAN_OPTIONS' || 'UBSAN_OPTIONS') }}: ${{ matrix.env_var }}
        run: ctest --output-on-failure --parallel 1

  # ============================================================================
  # macOS Build
  # ============================================================================
  macos-build:
    name: macOS ${{ matrix.build_type }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          brew install cmake ninja googletest eigen

      - name: Configure CMake
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTS=ON \
            -DBUILD_EXAMPLES=ON

      - name: Build
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Run tests
        working-directory: ${{ env.RESERVOIR_DIR }}/build
        run: ctest --output-on-failure --parallel $(sysctl -n hw.ncpu)

      - name: Upload build artifacts
        if: matrix.build_type == 'Release'
        uses: actions/upload-artifact@v6
        with:
          name: reservoir-echo-macos-${{ matrix.build_type }}
          path: |
            ${{ env.RESERVOIR_DIR }}/build/lib*
            ${{ env.RESERVOIR_DIR }}/build/*.a
            ${{ env.RESERVOIR_DIR }}/build/*.dylib
          retention-days: 30

  # ============================================================================
  # Windows Build
  # ============================================================================
  windows-build:
    name: Windows ${{ matrix.build_type }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install dependencies
        run: |
          choco install cmake ninja -y

      - name: Configure CMake
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: cmake -B build -G "Ninja" -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DBUILD_TESTS=ON -DBUILD_EXAMPLES=ON

      - name: Build
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: cmake --build build --parallel

      - name: Run tests
        working-directory: ${{ env.RESERVOIR_DIR }}/build
        run: ctest --output-on-failure --parallel

      - name: Upload build artifacts
        if: matrix.build_type == 'Release'
        uses: actions/upload-artifact@v6
        with:
          name: reservoir-echo-windows-${{ matrix.build_type }}
          path: |
            ${{ env.RESERVOIR_DIR }}/build/*.lib
            ${{ env.RESERVOIR_DIR }}/build/*.dll
            ${{ env.RESERVOIR_DIR }}/build/*.exe
          retention-days: 30

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: linux-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libgtest-dev libeigen3-dev gcovr lcov

      - name: Configure CMake with coverage
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: |
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
            -DBUILD_TESTS=ON

      - name: Build
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: cmake --build build --parallel $(nproc)

      - name: Run tests
        working-directory: ${{ env.RESERVOIR_DIR }}/build
        run: ctest --output-on-failure

      - name: Generate coverage report
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: |
          lcov --capture --directory build --output-file coverage.info
          lcov --remove coverage.info '/usr/*' '*/test/*' '*/external/*' --output-file coverage.info
          lcov --list coverage.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ${{ env.RESERVOIR_DIR }}/coverage.info
          flags: reservoir-echo
          name: reservoir-echo-coverage
          fail_ci_if_error: false

      - name: Generate HTML coverage report
        working-directory: ${{ env.RESERVOIR_DIR }}
        run: |
          genhtml coverage.info --output-directory coverage-report

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: ${{ env.RESERVOIR_DIR }}/coverage-report
          retention-days: 30

  # ============================================================================
  # Static Analysis
  # ============================================================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: linux-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libeigen3-dev clang-tools-15 cppcheck

      - name: Download compile commands
        uses: actions/download-artifact@v7
        with:
          name: compile-commands
          path: ${{ env.RESERVOIR_DIR }}/build

      - name: Run clang-tidy
        working-directory: ${{ env.RESERVOIR_DIR }}
        continue-on-error: true
        run: |
          find src include -name '*.cpp' -o -name '*.h' | \
            xargs clang-tidy-15 -p build \
              --checks='-*,bugprone-*,performance-*,readability-*,modernize-*' \
              --quiet 2>&1 | tee clang-tidy-report.txt

      - name: Run cppcheck
        working-directory: ${{ env.RESERVOIR_DIR }}
        continue-on-error: true
        run: |
          cppcheck --enable=all \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            --project=build/compile_commands.json \
            --xml 2>&1 | tee cppcheck-report.xml

      - name: Upload analysis reports
        uses: actions/upload-artifact@v6
        with:
          name: static-analysis-reports
          path: |
            ${{ env.RESERVOIR_DIR }}/clang-tidy-report.txt
            ${{ env.RESERVOIR_DIR }}/cppcheck-report.xml
          retention-days: 30
